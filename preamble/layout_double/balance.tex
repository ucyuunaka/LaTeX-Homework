% =============================================================================
% 栏平衡功能配置文件
% Column Balance Feature Configuration
% =============================================================================
% 文件用途：双栏布局中的栏平衡功能配置
% 创建日期：2025-08-03
% 版本：v1.0
% 
% 使用说明：
% 1. 本文件提供双栏布局中的栏平衡功能
% 2. 在主文档的 preamble 中使用 \input{preamble/layout_double/balance.tex} 引入
% 3. 建议在引入其他双栏配置文件之后引入本文件
% 4. 栏平衡可确保双栏页面左右栏高度尽可能相等
% 
% 配置内容包括：
% - 自动栏平衡设置
% - 手动栏平衡命令定义
% - 栏平衡的触发条件配置
% - 最后一页的栏平衡处理
% - 栏平衡与浮动体的协调
% - 栏平衡算法的参数调整
% 
% 常用命令（将在配置中定义）：
% - \balancecolumns : 强制当前页面栏平衡
% - \nobalancecolumns : 取消自动栏平衡
% - \lastpagebalance : 最后一页栏平衡
% 
% 注意事项：
% - 栏平衡可能影响页面排版效果
% - 与某些浮动体设置可能产生冲突
% - 建议根据具体文档内容调整平衡策略
% - 在文档最终定稿前进行栏平衡调试
% =============================================================================

% ========== 栏平衡包导入 ==========
\usepackage{balance}        % 双栏平衡包
\usepackage{multicol}       % 多栏支持包（可选，提供更多栏控制）

% ========== 自动栏平衡设置 ==========

% --- 最后一页自动平衡 ---
% 默认启用最后一页的栏平衡
\balance

% --- 栏平衡参数调整 ---
% 调整栏平衡的容差和算法参数
\makeatletter
% 设置栏平衡的最大迭代次数
\def\balance@max@iterations{10}

% 设置栏高差的容差（单位：pt）
\def\balance@tolerance{12pt}

% 设置栏平衡的惩罚值
\clubpenalty=10000          % 防止孤行
\widowpenalty=10000         % 防止寡行
\displaywidowpenalty=10000  % 防止公式后寡行
\makeatother

% ========== 手动栏平衡命令 ==========

% --- 基本栏平衡命令 ---
% 强制当前页面进行栏平衡
\newcommand{\balancecolumns}{%
    \vfill\eject
    \balance
}

% 取消自动栏平衡
\newcommand{\nobalancecolumns}{%
    \nobalance
}

% 恢复自动栏平衡
\newcommand{\restorebalance}{%
    \balance
}

% --- 条件栏平衡命令 ---
% 仅在最后一页进行栏平衡
\newcommand{\lastpagebalance}{%
    \AtEndDocument{\balance}
}

% 在指定页面进行栏平衡
\newcommand{\balancepage}[1]{%
    \AtBeginShipoutNext{\balance}
}

% ========== 栏平衡质量控制 ==========

% --- 栏间距调整 ---
% 在平衡时稍微增加栏间距以改善视觉效果
\newcommand{\adjustcolsepforbalance}{%
    \addtolength{\columnsep}{2pt}
}

% 恢复默认栏间距
\newcommand{\restorecolsep}{%
    \addtolength{\columnsep}{-2pt}
}

% --- 栏平衡质量检查 ---
% 检查当前页面是否需要栏平衡
\newcommand{\checkbalanceneed}{%
    \ifdim\pagetotal>\pagegoal
        \typeout{Warning: Page is overfull, consider manual balance}
    \fi
}

% ========== 与浮动体的协调 ==========

% --- 浮动体感知的栏平衡 ---
% 在有浮动体时更谨慎地进行栏平衡
\newcommand{\balancewithfloats}{%
    \clearpage  % 先处理所有浮动体
    \balance    % 然后进行栏平衡
}

% --- 跨栏浮动体后的平衡处理 ---
% 跨栏浮动体可能影响栏平衡，需要特殊处理
\newcommand{\balanceafterfigstar}{%
    \vspace{0pt plus 1fil}  % 添加弹性垂直空间
    \balance
}

% ========== 特殊情况处理 ==========

% --- 短页面栏平衡 ---
% 对于内容较少的页面，可能不需要强制平衡
\newcommand{\smartbalance}{%
    \ifdim\pagetotal<0.7\pagegoal
        \balance
    \else
        \typeout{Page too full for smart balance}
    \fi
}

% --- 段落感知的栏平衡 ---
% 避免在段落中间进行栏平衡
\newcommand{\paragraphawarebalance}{%
    \par
    \vspace{0pt plus 1fil}
    \balance
}

% ========== 栏平衡调试工具 ==========

% --- 显示栏平衡状态 ---
\newcommand{\showbalancestatus}{%
    \typeout{栏平衡状态信息：}%
    \typeout{  当前页面填充度: \the\pagetotal}%
    \typeout{  页面目标高度: \the\pagegoal}%
    \typeout{  栏间距: \the\columnsep}%
    \typeout{  平衡状态: \ifbalance@enabled{启用}\else{禁用}\fi}%
}

% --- 可视化栏平衡 ---
% 在调试时显示栏的边界
\newif\ifshowcolumns
\showcolumnsfalse  % 默认关闭

\newcommand{\showcolumnborders}{%
    \showcolumnstrue
    \makeatletter
    \def\columnseprule{0.1pt}
    \makeatother
}

\newcommand{\hidecolumnborders}{%
    \showcolumnsfalse
    \makeatletter
    \def\columnseprule{0pt}
    \makeatother
}

% ========== 高级栏平衡功能 ==========

% --- 渐进式栏平衡 ---
% 逐步调整栏平衡，避免突然的变化
\newcommand{\progressivebalance}{%
    \vspace{0pt plus 0.5fil}
    \balance
    \vspace{0pt plus 0.5fil}
}

% --- 内容感知平衡 ---
% 根据内容类型选择平衡策略
\newcommand{\contentawarebalance}[1]{%
    \if\relax\detokenize{#1}\relax
        % 无参数，使用默认平衡
        \balance
    \else
        \ifx#1\figure
            % 图片后的平衡
            \vspace{6pt plus 2pt minus 2pt}
            \balance
        \else\ifx#1\table
            % 表格后的平衡
            \vspace{4pt plus 2pt minus 1pt}
            \balance
        \else\ifx#1\equation
            % 公式后的平衡
            \vspace{3pt plus 1pt minus 1pt}
            \balance
        \else
            % 其他内容的默认平衡
            \balance
        \fi\fi\fi
    \fi
}

% ========== 栏平衡的全局策略 ==========

% --- 文档级栏平衡设置 ---
% 在文档开始时设置全局栏平衡策略
\AtBeginDocument{%
    \balance  % 启用自动栏平衡
    \typeout{双栏布局栏平衡功能已启用}
}

% --- 章节级栏平衡 ---
% 在每个章节开始时重置栏平衡
% 注意：为避免与已加载包的冲突，暂时禁用自动章节栏平衡
% 用户可手动调用 \balancecolumns 命令进行栏平衡
% \let\orig@section\section
% \renewcommand{\section}[1]{%
%     \balance
%     \orig@section{#1}
% }

% --- 文档结束时的栏平衡 ---
\AtEndDocument{%
    \balance
    \typeout{文档结束，最终栏平衡完成}
}