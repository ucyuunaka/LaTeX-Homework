# 重构重复代码地狱 (Refactor Code Duplication Hell)

## Why

通过全面代码审查发现项目中存在严重的重复代码问题，特别是 `preamble/common/packages.tex` 与 `preamble/mylab_style.sty` 之间几乎完全重复的宏包导入，以及多处自定义命令和设置的重复。这种重复代码地狱导致了维护困难、版本不一致、编译效率低下等问题，亟需系统性的重构来解决。

## 概述

通过全面代码审查发现项目中存在严重的重复代码问题，特别是 `preamble/common/packages.tex` 与 `preamble/mylab_style.sty` 之间几乎完全重复的宏包导入，以及多处自定义命令和设置的重复。此重构旨在消除代码重复，建立清晰的模块化架构。

## 问题识别

### 1. 严重的宏包导入重复
- **位置**: `preamble/common/packages.tex` (第6-65行) 和 `preamble/mylab_style.sty` (第15-74行)
- **问题**: 60个 `\RequirePackage` 语句完全重复，这是典型的复制粘贴编程
- **影响**: 维护困难，容易出现版本不一致，增加编译时间

### 2. 自定义命令重复
- **位置**: `preamble/common/commands.tex` 和 `preamble/mylab_style.sty` (第91-213行)
- **问题**: 定理环境、代码样式设置、自定义命令高度重复
- **影响**: 功能冗余，修改时需要同步多个文件

### 3. 布局设置部分重复
- **位置**: 单双栏布局文件中的页眉页脚设置
- **问题**: `\renewcommand{\headrulewidth}` 和 `\renewcommand{\footrulewidth}` 在多处重复定义
- **影响**: 样式不一致风险

## 解决方案

### 架构重新设计

建立清晰的三层架构：

1. **核心样式包层** (`mylab_style.sty`)
   - 包管理：通过 `\RequirePackage{common/packages}` 导入
   - 核心功能：提供样式包接口和版本控制
   - 逻辑控制：处理布局切换和条件加载

2. **通用模块层** (`preamble/common/`)
   - `packages.tex`: 统一的宏包导入
   - `commands.tex`: 通用的自定义命令和环境
   - `settings.tex`: 通用的格式设置

3. **布局特定层** (`preamble/layout_*/`)
   - 布局专用的设置和命令
   - 避免与通用层重复

### 重构策略

1. **消除宏包导入重复**
   - 将所有宏包导入集中在 `packages.tex`
   - `mylab_style.sty` 通过 `\RequirePackage{common/packages}` 导入
   - 移除 `mylab_style.sty` 中的重复宏包导入

2. **重构自定义命令**
   - 将通用命令集中在 `commands.tex`
   - 布局特定命令保留在对应布局文件中
   - 清理 `mylab_style.sty` 中的重复命令定义

3. **统一样式设置**
   - 将通用样式设置提取到独立文件
   - 布局特定覆盖放在布局配置中
   - 建立清晰的继承关系

## 预期收益

1. **维护性提升**: 消除重复代码，单一职责原则
2. **一致性保证**: 统一的宏包版本和配置
3. **编译效率**: 减少重复加载，缩短编译时间
4. **架构清晰**: 明确的模块边界和依赖关系
5. **扩展性增强**: 便于添加新功能和布局模式

## 风险评估

- **低风险**: 主要是代码重组，不改变功能
- **兼容性**: 保持对外接口不变
- **测试策略**: 逐文件重构，确保每步都可编译验证

## 实施计划

采用渐进式重构，分阶段验证，确保每个阶段都不会破坏现有功能。