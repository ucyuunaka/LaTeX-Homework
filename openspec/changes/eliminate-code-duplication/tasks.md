# 重复代码重构任务清单

## 任务概览

本重构旨在消除项目中严重的代码重复问题，特别是宏包导入和自定义命令的重复，建立清晰的模块化架构。

## 任务列表

### 阶段1: 准备和分析 (已完成)
- [x] **任务1.1**: 分析现有的重复代码模式
- [x] **任务1.2**: 检查项目结构和依赖关系
- [x] **任务1.3**: 制定重构计划和设计方案

### 阶段2: 宏包导入重构
- [ ] **任务2.1**: 验证当前编译状态
  - 编译测试当前文档，确保重构前功能正常
  - 记录编译时间和输出作为基准
  - 创建当前状态的备份

- [ ] **任务2.2**: 重构 mylab_style.sty 宏包导入部分
  - 移除第15-74行的重复宏包导入
  - 保留包管理相关的核心代码（第7-8行）
  - 添加 `\RequirePackage{common/packages}` 引用

- [ ] **任务2.3**: 验证宏包加载
  - 编译测试确保所有宏包正确加载
  - 检查是否有宏包冲突或缺失
  - 验证编译时间是否有所改善

### 阶段3: 自定义命令重构
- [ ] **任务3.1**: 检查 commands.tex 完整性
  - 验证 `common/commands.tex` 包含所有必要的命令
  - 确认定理环境、代码样式、自定义命令的完整性
  - 检查是否有遗漏的命令需要添加

- [ ] **任务3.2**: 移除 mylab_style.sty 中的重复命令
  - 移除第91-96行的定理环境定义
  - 移除第99-143行的代码样式设置
  - 移除第176-213行的自定义命令
  - 添加 `\RequirePackage{common/commands}` 引用

- [ ] **任务3.3**: 验证命令可用性
  - 测试所有自定义命令是否正常工作
  - 验证定理环境、代码高亮等功能
  - 确保命令参数和行为保持一致

### 阶段4: 核心设置分离
- [ ] **任务4.1**: 创建 core-settings.tex 文件
  - 创建 `preamble/common/core-settings.tex`
  - 从 `mylab_style.sty` 提取基础格式设置
  - 按功能模块组织设置内容

- [ ] **任务4.2**: 提取格式设置
  - 移动第81-87行的页面格式设置
  - 移动第99行的超链接设置
  - 移动第101-104行的颜色定义
  - 移动第165-173行的标题和列表设置

- [ ] **任务4.3**: 集成核心设置
  - 在 `mylab_style.sty` 中添加 `\RequirePackage{common/core-settings}`
  - 确保设置的加载顺序正确
  - 验证格式设置的效果

### 阶段5: 布局文件清理
- [ ] **任务5.1**: 检查布局文件重复
  - 分析单双栏布局文件中的重复设置
  - 识别可以通用的设置项
  - 清理布局文件中的冗余代码

- [ ] **任务5.2**: 优化布局设置
  - 确保布局特定设置只包含布局相关内容
  - 移除与通用设置重复的部分
  - 保持布局功能的完整性

### 阶段6: 验证和测试
- [ ] **任务6.1**: 完整编译测试
  - 测试单栏布局的完整编译
  - 测试双栏布局的完整编译
  - 验证所有功能正常工作

- [ ] **任务6.2**: 性能对比验证
  - 对比重构前后的编译时间
  - 检查生成的PDF文件一致性
  - 验证内存使用情况

- [ ] **任务6.3**: 文档更新
  - 更新项目文档说明新的架构
  - 更新开发指南和使用说明
  - 记录重构的收益和改进

### 阶段7: 清理和收尾
- [ ] **任务7.1**: 代码清理
  - 移除所有注释掉的重复代码
  - 统一代码格式和注释风格
  - 确保文件结构清晰

- [ ] **任务7.2**: 最终验证
  - 进行最后的完整性测试
  - 确认没有遗漏的重复代码
  - 验证项目结构符合设计要求

## 验收标准

### 功能性标准
- [ ] 所有现有功能保持正常工作
- [ ] 编译无错误和警告
- [ ] 生成的PDF内容与重构前完全一致
- [ ] 所有自定义命令和环境可用

### 质量标准
- [ ] 代码重复率降至最低
- [ ] 模块职责清晰明确
- [ ] 文件结构符合设计文档
- [ ] 编译时间有所改善或保持不变

### 维护性标准
- [ ] 代码易于理解和维护
- [ ] 文档完整准确
- [ ] 扩展性良好
- [ ] 符合LaTeX最佳实践

## 风险缓解

### 高风险任务
- **任务2.2**: 宏包导入重构 - 可能影响编译
  - 缓解：逐步移除，每步验证编译
- **任务3.2**: 命令移除 - 可能导致命令未定义
  - 缓解：先验证commands.tex完整性，再移除重复

### 回滚计划
- 每个阶段完成后创建git提交点
- 保留重构前的完整备份
- 记录每个步骤的具体修改内容
- 准备快速回滚脚本

## 时间估算

- **阶段2-3**: 核心重构 - 预计2-3小时
- **阶段4-5**: 优化清理 - 预计1-2小时
- **阶段6-7**: 验证收尾 - 预计1小时
- **总计**: 4-6小时（包含测试验证时间）

## 依赖关系

```
阶段2 (宏包重构) → 阶段3 (命令重构) → 阶段4 (设置分离)
                                     ↓
                              阶段5 (布局清理) → 阶段6 (验证测试) → 阶段7 (清理收尾)
```