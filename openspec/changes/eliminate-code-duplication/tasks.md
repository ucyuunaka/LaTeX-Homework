# 重复代码重构任务清单

## 任务概览

本重构旨在消除项目中严重的代码重复问题，特别是宏包导入和自定义命令的重复，建立清晰的模块化架构。

## 任务列表

### 阶段1: 准备和分析 (已完成)
- [x] **任务1.1**: 分析现有的重复代码模式
- [x] **任务1.2**: 检查项目结构和依赖关系
- [x] **任务1.3**: 制定重构计划和设计方案

### 阶段2: 宏包导入重构
- [ ] **任务2.1**: 验证当前编译状态
  - 编译测试当前文档，确保重构前功能正常
  - 记录编译时间和输出作为基准
  - 创建当前状态的备份

- [ ] **任务2.2**: 重构 mylab_style.sty 宏包导入部分
  - 移除第15-74行的重复宏包导入
  - 保留包管理相关的核心代码（第7-8行）
  - 添加 `\RequirePackage{common/packages}` 引用

- [ ] **任务2.3**: 验证宏包加载
  - 编译测试确保所有宏包正确加载
  - 检查是否有宏包冲突或缺失
  - 验证编译时间是否有所改善

### 阶段3: 自定义命令重构
- [ ] **任务3.1**: 检查 commands.tex 完整性和依赖问题
  - 验证 `common/commands.tex` 包含所有必要的命令
  - **关键修复**: 识别并记录 `\noteboxwidth` 变量依赖问题
  - 检查第98行的变量引用问题
  - 准备重新设计布局感知命令

- [ ] **任务3.2**: 移除 mylab_style.sty 中的重复命令
  - 移除第91-96行的定理环境定义
  - 移除第99-143行的代码样式设置
  - 移除第176-213行的自定义命令
  - **关键提取**: 提取第81-87行的页面格式设置到 core-settings.tex

- [ ] **任务3.3**: 验证命令可用性
  - 测试所有自定义命令是否正常工作
  - **重点验证**: `\notebox` 命令在不同布局中的行为
  - 确保命令参数和行为保持一致

### 阶段4: 变量依赖重构 (新增 - 高风险)
- [ ] **任务4.1**: 解决 noteboxwidth 依赖问题
  - 分析 `\notebox` 命令的布局依赖机制
  - 重新设计命令为布局感知，不依赖布局变量
  - 确保单栏和双栏布局中行为一致

- [ ] **任务4.2**: 统一模块引用接口
  - 将 `layout_*/settings.tex:9-10` 的 `\input` 改为 `\RequirePackage`
  - 统一所有布局文件的模块引用方式
  - 严格控制加载顺序确保依赖正确

- [ ] **任务4.3**: 验证接口一致性
  - 测试所有布局文件的模块加载
  - 确保不出现接口不一致的编译错误
  - 验证样式优先级保持不变

### 阶段5: 代码样式继承重构 (新增)
- [ ] **任务5.1**: 创建代码样式基础模块
  - 创建 `common/code-base-settings.tex`
  - 从 `commands.tex` 提取基础代码样式设置
  - 从 `layout_double/settings.tex:53-88` 提取差异化配置

- [ ] **任务5.2**: 重构布局代码样式继承
  - 修改双栏布局使用继承机制
  - 保留布局特定的优化（字体更小、关闭行号等）
  - 移除重复的代码样式定义

- [ ] **任务5.3**: 验证代码样式一致性
  - 测试不同布局下的代码高亮效果
  - 确保继承机制正常工作
  - 验证布局特定优化生效

### 阶段6: 核心设置分离
- [ ] **任务4.1**: 创建 core-settings.tex 文件
  - 创建 `preamble/common/core-settings.tex`
  - 从 `mylab_style.sty` 提取基础格式设置
  - 按功能模块组织设置内容

- [ ] **任务4.2**: 提取格式设置
  - 移动第81-87行的页面格式设置
  - 移动第99行的超链接设置
  - 移动第101-104行的颜色定义
  - 移动第165-173行的标题和列表设置

- [ ] **任务4.3**: 集成核心设置
  - 在 `mylab_style.sty` 中添加 `\RequirePackage{common/core-settings}`
  - 确保设置的加载顺序正确
  - 验证格式设置的效果

### 阶段7: 布局文件清理
- [ ] **任务5.1**: 检查布局文件重复
  - 分析单双栏布局文件中的重复设置
  - 识别可以通用的设置项
  - 清理布局文件中的冗余代码

- [ ] **任务5.2**: 优化布局设置
  - 确保布局特定设置只包含布局相关内容
  - 移除与通用设置重复的部分
  - 保持布局功能的完整性

### 阶段8: 构建配置更新 (新增 - 高风险)
- [ ] **任务8.1**: 更新 latexmkrc 配置
  - 检查并更新 `.latexmkrc` 以反映新的文件结构
  - 确保输出目录和依赖路径正确
  - 测试编译配置是否适配新架构

- [ ] **任务8.2**: 适配构建脚本
  - 检查 `build.py` 脚本是否需要调整
  - 验证构建流程处理新模块文件的能力
  - 测试错误处理和依赖检查

- [ ] **任务8.3**: 更新项目文档
  - 更新 `README.md` 说明新的三层架构
  - 记录各模块职责和依赖关系
  - 更新使用说明和开发指南

### 阶段9: 验证和测试
- [ ] **任务6.1**: 完整编译测试
  - 测试单栏布局的完整编译
  - 测试双栏布局的完整编译
  - 验证所有功能正常工作

- [ ] **任务6.2**: 性能对比验证
  - 对比重构前后的编译时间
  - 检查生成的PDF文件一致性
  - 验证内存使用情况

- [ ] **任务6.3**: 文档更新
  - 更新项目文档说明新的架构
  - 更新开发指南和使用说明
  - 记录重构的收益和改进

### 阶段10: 清理和收尾
- [ ] **任务7.1**: 代码清理
  - 移除所有注释掉的重复代码
  - 统一代码格式和注释风格
  - 确保文件结构清晰

- [ ] **任务7.2**: 最终验证
  - 进行最后的完整性测试
  - 确认没有遗漏的重复代码
  - 验证项目结构符合设计要求

## 验收标准

### 功能性标准
- [ ] 所有现有功能保持正常工作
- [ ] 编译无错误和警告
- [ ] 生成的PDF内容与重构前完全一致
- [ ] 所有自定义命令和环境可用

### 质量标准
- [ ] 代码重复率降至最低
- [ ] 模块职责清晰明确
- [ ] 文件结构符合设计文档
- [ ] 编译时间有所改善或保持不变

### 维护性标准
- [ ] 代码易于理解和维护
- [ ] 文档完整准确
- [ ] 扩展性良好
- [ ] 符合LaTeX最佳实践

## 风险缓解

### 高风险任务
- **任务2.2**: 宏包导入重构 - 可能影响编译
  - 缓解：逐步移除，每步验证编译
- **任务3.2**: 命令移除 - 可能导致命令未定义
  - 缓解：先验证commands.tex完整性，再移除重复
- **任务4.1**: noteboxwidth依赖修复 - 🔴 极高风险
  - 缓解：深入分析变量依赖机制，重新设计命令为布局感知
- **任务4.2**: 接口统一 - 🟡 中等风险
  - 缓解：逐步替换引用方式，确保加载顺序正确
- **任务8.1**: 构建配置更新 - 🔴 高风险
  - 缓解：先备份原配置，逐步测试和更新

### 回滚计划
- 每个阶段完成后创建git提交点
- 保留重构前的完整备份
- 记录每个步骤的具体修改内容
- 准备快速回滚脚本

## 时间估算

- **阶段2-3**: 核心重构 - 预计2-3小时
- **阶段4-5**: 变量依赖和代码样式重构 - 预计2-3小时（高风险）
- **阶段6-7**: 设置分离和布局清理 - 预计1-2小时
- **阶段8-10**: 配置更新和验证收尾 - 预计1-2小时
- **总计**: 6-10小时（包含测试验证时间，额外考虑高风险任务的缓冲时间）

## 依赖关系

```
阶段2 (宏包重构) → 阶段3 (命令重构) → 阶段4 (变量依赖重构) → 阶段5 (代码样式重构)
                                                                 ↓
阶段6 (设置分离) → 阶段7 (布局清理) → 阶段8 (配置更新) → 阶段9 (验证测试) → 阶段10 (清理收尾)
```

**关键路径**:
- 阶段4 (变量依赖重构) 是最关键的高风险任务，需要优先处理
- 阶段8 (配置更新) 必须在所有代码重构完成后进行
- 每个阶段都必须通过编译验证才能进入下一阶段